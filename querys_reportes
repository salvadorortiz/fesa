--DROP VIEW dt_repo_reserva;

CREATE OR REPLACE VIEW dt_repo_reserva AS 
 SELECT com.complejo_id,
    can.cancha_id,
    recan.reserva_cancha_id,
    res.reserva_id,
    fpag.forma_pago_id, 
    to_char(res.fecha_ingreso::timestamp with time zone, 'YYYY-MM-DD'::text) AS fecha_reserva,
    u.usuario,
        CASE
            WHEN c.cliente_id IS NOT NULL THEN COALESCE(c.nombre, ''::character varying)
            ELSE COALESCE(e.nombre, ''::character varying)
        END AS info_cliente,
    res.nombre_evento,
        CASE
            WHEN res.estado::text = 'C'::text THEN '<span class="label label-primary">Confirmado</span>'::text
            WHEN res.estado::text = 'T'::text THEN '<span class="label label-default">Tentativo</span>'::text
            WHEN res.estado::text = 'R'::text THEN '<span class="label label-success">Realizado</span>'::text
            WHEN res.estado::text = 'N'::text THEN '<span class="label label-danger">No realizado</span>'::text
            ELSE NULL::text
        END AS estado_reserva,
    fpag.nombre AS nombre_formapago,
        CASE
            WHEN res.forma_pago_id = 1 THEN '$'::text || to_char(res.precio, '9G999.99'::text)
            ELSE ''::text
        END AS precio_reserva
--SELECT *
   FROM modulo_1_complejo com
     JOIN modulo_1_cancha can ON can.complejo_id = com.complejo_id
     JOIN modulo_1_reservacancha recan ON recan.cancha_id = can.cancha_id
     JOIN modulo_1_reserva res ON res.reserva_id = recan.reserva_id
     JOIN modulo_1_formapago fpag ON fpag.forma_pago_id = res.forma_pago_id
     JOIN modulo_1_formafacturacion ff ON ff.forma_facturacion_id = res.forma_facturacion_id
     JOIN modulo_1_tipoalquiler ta ON ta.tipo_alquiler_id = res.tipo_alquiler_id
     JOIN modulo_1_usuario u ON u.usuario_id= res.usuario_id
     LEFT JOIN modulo_1_cliente c ON c.cliente_id = res.cliente_id
     LEFT JOIN modulo_1_empresa e ON e.empresa_id = res.empresa_id
  ORDER BY recan.fecha DESC;


CREATE OR REPLACE VIEW dt_repo_clientes AS 
 SELECT '<i class="fa fa-child"></i>'::text AS tipo,
    c.nombre AS nombre_cliente,
    c.ingresado_por,
    ( SELECT modulo_1_reserva.nombre_evento || ' ('|| modulo_1_reserva.fecha_ingreso|| ')'
           FROM modulo_1_reserva
          WHERE modulo_1_reserva.cliente_id = c.cliente_id
          ORDER BY modulo_1_reserva.fecha_ingreso
         LIMIT 1) AS primer_evento,
    ( SELECT modulo_1_reserva.nombre_evento|| ' ('|| modulo_1_reserva.fecha_ingreso|| ')'
           FROM modulo_1_reserva
          WHERE modulo_1_reserva.cliente_id = c.cliente_id
          ORDER BY modulo_1_reserva.fecha_ingreso DESC
         LIMIT 1) AS ultimo_evento,
    1 as tipo_tabla,
    '<button name="ver_eventos" class="btn btn-xs btn-warning"><i class="fa fa-eye bigger-120"></i></button>' as boton,
    cliente_id as id
   FROM modulo_1_cliente c
UNION
 SELECT '<i class="fa fa-building"></i>'::text AS tipo,
    c.nombre AS nombre_cliente,
    c.ingresado_por,
    ( SELECT modulo_1_reserva.nombre_evento || ' ('|| modulo_1_reserva.fecha_ingreso|| ')'
           FROM modulo_1_reserva
          WHERE modulo_1_reserva.empresa_id = c.empresa_id
          ORDER BY modulo_1_reserva.fecha_ingreso
         LIMIT 1) AS primer_evento,
    ( SELECT modulo_1_reserva.nombre_evento || ' ('|| modulo_1_reserva.fecha_ingreso|| ')'
           FROM modulo_1_reserva
          WHERE modulo_1_reserva.empresa_id = c.empresa_id
          ORDER BY modulo_1_reserva.fecha_ingreso DESC
         LIMIT 1) AS ultimo_evento,
    2 as tipo_tabla,
    '<button name="ver_eventos" class="btn btn-xs btn-warning"><i class="fa fa-eye bigger-120"></i></button>' as boton,
    empresa_id as id
   FROM modulo_1_empresa c;




CREATE OR REPLACE VIEW dt_repo_remesa AS 
 SELECT res.reserva_id,
    to_char(res.fecha_ingreso::timestamp with time zone, 'YYYY-MM-DD'::text) AS fecha_ingreso,
    res.nombre_evento,
        CASE
            WHEN c.cliente_id IS NULL THEN e.nombre
            ELSE c.nombre
        END AS nombre_cliente,
    u.nombre AS nombre_usuario,
    '$'::text || COALESCE(to_char(res.precio, '9G999.99'::text), to_char(0, '9G999.99'::text)) AS precio,
    '$'::text || COALESCE(to_char(res.costo, '9G999.99'::text), to_char(0, '9G999.99'::text)) AS costo,
    '$'::text || COALESCE(to_char(res.precio - res.costo, '9G999.99'::text), to_char(0, '9G999.99'::text)) AS utilidad,
    '$'::text || COALESCE(to_char(( SELECT sum(modulo_1_remesaxreserva.monto) AS sum
           FROM modulo_1_remesaxreserva
          WHERE modulo_1_remesaxreserva.reserva_id = res.reserva_id), '9G999.99'::text), to_char(0, '9G999.99'::text)) AS remesado,
    '$'::text || COALESCE(to_char(res.precio - COALESCE((( SELECT sum(modulo_1_remesaxreserva.monto) AS sum
           FROM modulo_1_remesaxreserva
          WHERE modulo_1_remesaxreserva.reserva_id = res.reserva_id)),0), '9G999.99'::text), to_char(0, '9G999.99'::text)) AS remanente,
    res.usuario_id AS usuario
 --SELECT * 
   FROM modulo_1_remesaxreserva rr
     RIGHT JOIN modulo_1_reserva res ON rr.reserva_id = res.reserva_id
     JOIN modulo_1_usuario u ON res.usuario_id = u.usuario_id
     LEFT JOIN modulo_1_cliente c ON res.cliente_id = c.cliente_id
     LEFT JOIN modulo_1_empresa e ON res.empresa_id = e.empresa_id
  GROUP BY res.reserva_id, c.cliente_id, e.nombre, res.nombre_evento, res.usuario_id, u.nombre;
  
  
Create or replace view dt_repo_cliente_eventos as
SELECT 
case 
	when cliente_id is null then 2
	else 1
end as tipo_registro,
case
	when cliente_id is null then empresa_id
	else cliente_id
end as id_registro, nombre_evento,
'$' || COALESCE(to_char(precio, '9G999.99'), to_char(0, '9G999.99')) as precio,
to_char(fecha_ingreso, 'YYYY-MM-DD') AS fecha_reserva
FROM modulo_1_reserva
order by fecha_ingreso desc;


CREATE OR REPLACE VIEW dt_repo_horas AS 
 SELECT c.cancha_id,
    c.complejo_id,
    res.tipo_alquiler_id,
    to_char(rxc.fecha::timestamp with time zone, 'YYYY-MM-DD'::text) AS fecha_ingreso,
    ((('<div class="row"><div class="col-sm-12"><div class="col-sm-4"></div><div class="col-sm-4 text-capitalize text-center"><h4 style="color:#074515">'::text || c.nombre::text) || '</h4></div><div class="col-sm-4 text-right"><h6><span class="label label-default">'::text) || com.nombre::text) || '</span></h6></div></div></div>'::text AS nombre_cancha,
    COALESCE(to_char(( SELECT sum(rxcan.hora_fin - rxcan.hora_inicio) AS sum
           FROM modulo_1_cancha can
             JOIN modulo_1_reservacancha rxcan ON can.cancha_id = rxcan.cancha_id
             JOIN modulo_1_reserva reser ON reser.reserva_id = rxcan.reserva_id
          WHERE can.cancha_id = c.cancha_id AND reser.tipo_alquiler_id = res.tipo_alquiler_id AND reser.reserva_id = res.reserva_id
          GROUP BY can.cancha_id, reser.reserva_id, reser.tipo_alquiler_id), 'HH24:MI:SS'::text), '00:00:00'::text) AS horas_ocupadas,
    ''::text || (( SELECT (( SELECT 5::double precision * sum(modulo_1_precioxcancha_1.hora_cierre - modulo_1_precioxcancha_1.hora_apertura)
                   FROM modulo_1_precioxcancha modulo_1_precioxcancha_1
                  WHERE modulo_1_precioxcancha_1.cancha_id = c.cancha_id AND modulo_1_precioxcancha_1.dia::text = 'X'::text
                  GROUP BY modulo_1_precioxcancha_1.cancha_id)) + sum(modulo_1_precioxcancha.hora_cierre - modulo_1_precioxcancha.hora_apertura)
           FROM modulo_1_precioxcancha
          WHERE modulo_1_precioxcancha.cancha_id = c.cancha_id AND modulo_1_precioxcancha.dia::text <> 'X'::text
          GROUP BY modulo_1_precioxcancha.cancha_id)) AS horas_posibles,
    c.horas_posibles AS horas_posibles_2
   FROM modulo_1_cancha c
     JOIN modulo_1_complejo com ON com.complejo_id = c.complejo_id
     LEFT JOIN modulo_1_reservacancha rxc ON c.cancha_id = rxc.cancha_id
     LEFT JOIN modulo_1_precioxcancha pxc ON c.cancha_id = pxc.cancha_id
     LEFT JOIN modulo_1_reserva res ON res.reserva_id = rxc.reserva_id
     LEFT JOIN modulo_1_tipoalquiler ta ON res.tipo_alquiler_id = ta.tipo_alquiler_id
  GROUP BY c.cancha_id, c.complejo_id, res.tipo_alquiler_id, res.reserva_id, rxc.fecha, ta.nombre, com.nombre
  ORDER BY c.cancha_id;




CREATE OR REPLACE VIEW dt_repo_horasposibles AS
SELECT   
         c.cancha_id,c.complejo_id,
         COALESCE(''||((( SELECT 5 * sum(modulo_1_precioxcancha_1.hora_cierre - modulo_1_precioxcancha_1.hora_apertura)
                   FROM modulo_1_precioxcancha modulo_1_precioxcancha_1 
                   WHERE modulo_1_precioxcancha_1.cancha_id=c.cancha_id AND modulo_1_precioxcancha_1.dia::text = 'X'
                  GROUP BY modulo_1_precioxcancha_1.cancha_id)) 
         + 
         sum(pxc.hora_cierre - pxc.hora_apertura)),c.horas_posibles||':00:00')
--SELECT *
FROM modulo_1_cancha c 
LEFT JOIN modulo_1_precioxcancha pxc 
ON c.cancha_id=pxc.cancha_id
WHERE (pxc.dia::text <> 'X' or pxc.dia is null)
GROUP BY c.cancha_id
